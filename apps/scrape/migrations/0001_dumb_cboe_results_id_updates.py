# Generated by Django 2.1.5 on 2019-02-22 21:48
import requests, re
from apps.candidates.models import Candidate
from apps.races.models import Race
from django.db import migrations


### START CONFIG ###
scrape_target = 'https://chicagoelections.com/results/ap/summary.txt'
data_line_range_start, data_line_range_end = 3,182
race_code_range_start, race_code_range_end = 0,4
cand_code_range_start, cand_code_range_end = 5,7
race_name_range_start, race_name_range_end = 32,57
cand_name_range_start, race_name_range_end = 88,112
### END CONFIG ###


def init(apps,schema_editor):
    # get page and interate through data
    page = get_page()
    data = page[data_line_range_start:data_line_range_end]
    for datum in data:
        # parse codes, names for races, candidates
        race_code = get_race_code(datum)
        race_name = get_race_name(datum)
        race = lookup_race_by_cboe_name(race_name)
        # lookup race and update cboe results id
        if race:
            race.cboe_results_id = race_code
            # lookup candidates
            cand_code = get_cand_code(datum)
            cand_name = get_cand_name(datum)
            cand = lookup_cand_by_cboe_name(datum,race)
            cand.cboe_results_id = cand_code
            race.save()
            cand.save()

def get_page():
    return requests.get(scrape_target).content

def get_race_code(line):
    return line[race_code_range_start:race_code_range_end]

def get_cand_code(line):
    return line[cand_code_range_start:cand_code_range_end]

def get_race_name(line):
    return line[race_name_range_start:race_name_range_end].strip()

def get_cand_name(line):
    return line[cand_name_range_start:cand_name_range_end]

def lookup_race_by_cboe_name(cboe_race):
    return Race.objects.get(id=re.findall('\d+',cboe_race))

def lookup_cand_by_cboe_name(cboe_first_name,race):
    return Candidate.objects.get(race=race,last_name__icontains=cboe_name.split(' ')[0])


class Migration(migrations.Migration):

    dependencies = [
    ]

    operations = [
            migrations.RunPython(init)
    ]
